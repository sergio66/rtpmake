function p = p91_ecmwf(psfc, lhalf);

% function [p] = p91_ecmwf( psfc, lhalf );
%
% Calculate the 91 ECMWF "full-level" pressures based upon the
% surface pressure.  Levels 1-34 (0.010 to 70.506 mb) are constants,
% while levels 35-91 vary such that level 91 is just slightly less
% than the surface pressure.  If optional argument "lhalf" equals 1
% then it returns "half-level" pressures instead.
%
% Input:
%    psfc  : (1 x nprof) surface pressure (mb)
%    lhalf : OPTIONAL (1 x 1) output half-levels? {1=true, 0=false=default}
%
% Output:
%    p     : (91 x nprof) ECMWF pressure levels (mb)
%

% Generates ECMWF "full-level" pressures. Data from
% http://www.ecmwf.int/products/data/technical/model_levels/model_def_91.html
%
% Note:  a91 & b91 are in Pascal's, so you will see some *100 and
%        /100's in the code to switch from hPa to Pa.
%
% Created: 14 Mar 2006, Scott Hannon - based on p60_ecmwf.m (ie old p_ecmwf.m)
% Update: 07 Apr 2009, S.Hannon - added code for optional half-levels output
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

if (nargin < 1 | nargin > 2)
   error('Unexpected number of input arguments')
end
if (nargin == 1)
   lhalf = 0;
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sigma to half-level coefficients
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

a91=[ 0.000000;     2.000040;     3.980832;     7.387186;    12.908319; ...
     21.413612;    33.952858;    51.746601;    76.167656;   108.715561; ...
    150.986023;   204.637451;   271.356506;   352.824493;   450.685791; ...
    566.519226;   701.813354;   857.945801;  1036.166504;  1237.585449; ...
   1463.163940;  1713.709595;  1989.874390;  2292.155518;  2620.898438; ...
   2976.302246;  3358.425781;  3767.196045;  4202.416504;  4663.776367; ...
   5150.859863;  5663.156250;  6199.839355;  6759.727051;  7341.469727; ...
   7942.926270;  8564.624023;  9208.305664;  9873.560547; 10558.881836; ...
  11262.484375; 11982.662109; 12713.897461; 13453.225586; 14192.009766; ...
  14922.685547; 15638.053711; 16329.560547; 16990.623047; 17613.281250; ...
  18191.029297; 18716.968750; 19184.544922; 19587.513672; 19919.796875; ...
  20175.394531; 20348.916016; 20434.158203; 20426.218750; 20319.011719; ...
  20107.031250; 19785.357422; 19348.775391; 18798.822266; 18141.296875; ...
  17385.595703; 16544.585938; 15633.566406; 14665.645508; 13653.219727; ...
  12608.383789; 11543.166992; 10471.310547;  9405.222656;  8356.252930; ...
   7335.164551;  6353.920898;  5422.802734;  4550.215820;  3743.464355; ...
   3010.146973;  2356.202637;  1784.854614;  1297.656128;   895.193542; ...
    576.314148;   336.772369;   162.043427;    54.208336;     6.575628; ...
      0.003160;     0.000000 ];

b91 = [ 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; ...
        0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; ...
        0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; ...
        0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; ...
        0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000000; ...
        0.000000; 0.000000; 0.000000; 0.000000; 0.000000; 0.000014; ...
        0.000055; 0.000131; 0.000279; 0.000548; 0.001000; 0.001701; ...
        0.002765; 0.004267; 0.006322; 0.009035; 0.012508; 0.016860; ...
        0.022189; 0.028610; 0.036227; 0.045146; 0.055474; 0.067316; ...
        0.080777; 0.095964; 0.112979; 0.131935; 0.152934; 0.176091; ...
        0.201520; 0.229315; 0.259554; 0.291993; 0.326329; 0.362203; ...
        0.399205; 0.436906; 0.475016; 0.513280; 0.551458; 0.589317; ...
        0.626559; 0.662934; 0.698224; 0.732224; 0.764679; 0.795385; ...
        0.824185; 0.850950; 0.875518; 0.897767; 0.917651; 0.935157; ...
        0.950274; 0.963007; 0.973466; 0.982238; 0.989153; 0.994204; ...
        0.997630; 1.000000 ];


%%%%%%%%%%%%
% Check psfc
%%%%%%%%%%%%
[nrow,ncol]=size(psfc);
if (nrow ~= 1)
   disp('Error: psfc must be a (1 x nprof) vector!')
   return
else
   nprof=ncol;
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Calculate pressure levels
%%%%%%%%%%%%%%%%%%%%%%%%%%%

% "Half-level" pressures (layer boundary)
phalf = ( a91*ones(1,nprof) + ...
   ( b91*ones(1,nprof) ) .* ( ones(92,1)*(psfc*100) ) )/100;

% Average half-levels to get "full-level" pressures (layer mean)
% Note: the ECMWF web page doc says: "The prognostic variables are
% represented by their values at `full-level' pressures", ie
% the T, H2O, O3 profiles are at the full-level pressures.

if (lhalf == 1)
  p = phalf(2:92,:);
else
   % Average half-levels to get full-level pressures
   p = ( phalf(1:91,:) + phalf(2:92,:) )/2;
end

%%% end of function %%%
